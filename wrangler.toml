# Cloudflare Workers Configuration
# Docs: https://developers.cloudflare.com/workers/wrangler/configuration/

name = "investigacao-api"
main = "workers/index.ts"
compatibility_date = "2025-04-01"
compatibility_flags = ["nodejs_compat"]

# Account info (preencher após criar Workers)
account_id = "ce11d202b2917777965b5131b5edc627"
workers_dev = true

# Build configuration
# [build]
# command = "npm run build"
# upload.format = "service-worker"

# KV Namespaces (para cache)
[[kv_namespaces]]
binding = "KV"
id = "a04f4f78d7724b47a1a9a9717dbaa880" # investigacao-rate-limits
preview_id = "" # wrangler kv:namespace create "KV" --preview

# Routes (produção) - API subdomain only
[[routes]]
pattern = "api.investigacao.com.br/*"
zone_name = "investigacao.com.br"

# IMPORTANTE: O domínio principal investigacao.com.br deve ser configurado
# no Cloudflare Pages Dashboard → Custom Domains
# Não adicionar rota de Worker para o domínio principal!

# Static site configuration (disabled - using Pages instead)
# [site]
# bucket = "./dist"

# Browser Rendering (habilitar no dashboard)
[browser]
binding = "BROWSER"

# R2 Storage (habilitado e bucket criado)
[[r2_buckets]]
binding = "R2"
bucket_name = "investigacao-storage"

# D1 Database (SQLite nativo do Cloudflare)
[[d1_databases]]
binding = "DB"
database_name = "investigacao-db"
database_id = "55450973-0441-4aa6-964c-c4519902092c"

# Environment variables (não-sensíveis)
[vars]
ENVIRONMENT = "production"
APP_VERSION = "1.0.0"

# ============================================
# PRODUCTION ENVIRONMENT
# ============================================
[env.production]
name = "investigacao-prod"
vars = { ENVIRONMENT = "production" }

# ============================================
# STAGING ENVIRONMENT
# ============================================
[env.staging]
name = "investigacao-staging"
vars = { ENVIRONMENT = "staging" }

# ============================================
# DEVELOPMENT
# ============================================
[env.development]
name = "investigacao-dev"
vars = { ENVIRONMENT = "development" }

# ============================================
# OBSERVABILITY (opcional - para logs avançados)
# ============================================
[observability]
enabled = true

# ============================================
# TRIGGERS (Cron Jobs para processar relatórios)
# Desabilitado: Free tier permite apenas 5 cron triggers no total
# ============================================
# [triggers]
# crons = ["0 */6 * * *"] # Rodar a cada 6 horas

# ============================================
# LIMITS (desabilitado para plano Free)
# ============================================
# [limits]
# cpu_ms = 50 # 50ms no free tier, até 50.000ms no paid

# ============================================
# SECRETS (adicionar via: wrangler secret put NOME_SECRET)
# ============================================
# SUPABASE_SERVICE_ROLE_KEY
# FIREBASE_ADMIN_CREDENTIALS
# STRIPE_SECRET_KEY
# STRIPE_WEBHOOK_SECRET
# OPENAI_API_KEY
# GOOGLE_API_KEY
# API_BRASIL_BEARER_TOKEN
# API_BRASIL_DEVICE_TOKEN
# DEHASHED_EMAIL
# DEHASHED_API_KEY
# URL_SECRET
# JWT_SECRET

# ============================================
# NOTES
# ============================================
# 1. Adicionar secrets: npx wrangler secret put SECRET_NAME
# 2. Ver secrets: npx wrangler secret list
# 3. Deploy: npx wrangler deploy
# 4. Logs: npx wrangler tail
# 5. KV namespaces: wrangler kv:namespace create "NOME"
